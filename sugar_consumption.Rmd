---
title: "Heat Map Examples"
subtitle: "sugar_consumption.Rmd"
output: pdf_document
date: "2024-05-16"
author: "AJR"
fontsize: 12pt
header-includes: \usepackage{float}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```

# Introduction  
  
This material may be of use for this short course:  
  
  
Session Date / Time:	8/4/2024, 1:00 pm - 4:00 pm (California Time)  
Title:	Heatmaps, Colour Spaces, and Bubble Plots With R  

\bigskip  
  
  

The term *heatmap* may mean different things to different people. Some people may strongly associate the term with bioinformatics. Generally speaking, we are interested in cases where we have an x- variable and an y- variable plotted to the horizontal and vertical axes, and a third variable that is plotted  to colour. We can also include cases where spatial polygons are plotted to colour of fill; such plots seems to be popular (and some people may strongly associate the term *map* with a geographic map).  
  
We might call a scatterplot that maps a third variable to colour a *confetti plot*; the term *confetti plot* does not yet seem to be in general use.  

  
  
\pagebreak  
  
  
  
Load some R packages:  
  
```{r}
suppressPackageStartupMessages(library(sf))
library(sp)
library(ggplot2)
library(maps)
suppressPackageStartupMessages(library(dplyr))
```

\pagebreak  
  
  
# Draw a Map of the World  
 
 

Get some map data:   
  
```{r}
world_map <- map_data("world")
class(world_map)
```

Create an sf dataframe: 
```{r}
# Perhaps a better method:
# XY <- st_sfc(st_multipoint(cbind(world_map$long, world_map$lat)))
# XY <- st_cast(XY, "POINT")
# world_map2 <- world_map
# world_map2$geometry <- XY etc.

xy_points <- SpatialPoints(cbind(world_map$long, world_map$lat))
xy_points <- st_as_sfc(xy_points)

ids <- world_map$group

xy_multipoint <- st_cast(xy_points, to = "MULTIPOINT", ids = ids)
xy_polygon <- st_cast(xy_multipoint, to = "POLYGON")

polygon_sf <- st_sf(data.frame(geometry = xy_polygon, group = unique(ids)))

# Not run:
plot(polygon_sf)
```

It seems that there ought to be an easier way to transform the `maps` package data frame into an sf data frame.  
  


\pagebreak  
  
  
  
# Combine Sugar Availability Data with Map Data  
  
  
Combine the sugar data with the map data:  
  


```{r, fig.cap = "Many of the missing values are due to mismatches in region names.", out.extra = ""}

world_map_summary <- summarize(group_by(world_map, group, region, subregion), 
                               .groups = "keep")

polygon_sf <- left_join(polygon_sf, world_map_summary, by = "group")


sugar_data <- read.csv("WHO_sugar_data.csv")


sugar_data$region <- sugar_data$Location


polygon_sf <- left_join(polygon_sf, sugar_data[,c("region", "Value")], 
                        by = "region")

ggplot(polygon_sf) +
  geom_sf(aes(fill = Value)) 
```
\pagebreak  
  
  
Several of the `region` names in the map data do not match the `Location` names in the sugar data. Will will fix some of these mismatches manually.  
  
  
  
```{r}  
sugar_data[sugar_data$Location == "United States of America",]$region <- 
  "USA"

sugar_data[sugar_data$Location == "United Kingdom of Great Britain and Northern Ireland",]$region <- 
  "UK"

sugar_data[sugar_data$Location == "Russian Federation",]$region <- "Russia"
sugar_data[sugar_data$Location =="Bolivia (Plurinational State of)",]$region <- 
  "Bolivia"

sugar_data[sugar_data$Location =="Venezuela (Bolivarian Republic of)",]$region <-
  "Venezuela"
```

Remove previous `Value` column to avoid a duplicated column:  

```{r}
polygon_sf <- polygon_sf[,names(polygon_sf) != "Value"]
```

Re-join the sugar data:  
 
```{r}
polygon_sf <- left_join(polygon_sf, sugar_data[,c("region", "Value")], 
                        by = "region")
```

Re-draw the map:  

```{r, fig.cap = "Now fewer countries have data missing."}
ggplot(polygon_sf) +
  geom_sf(aes(fill = Value)) 
```

The `left_join()` function will not automatically replace the values in the `Value` column; thus that column has been dropped before re-joining the sugar data values.  
  

\pagebreak  
  
  
# Add Text Labels to the Map  
  
  
  
The colour scale may let us seem some general patterns; however, the colour scale does not make it easy to read off a data value for any particular country.  
  
To add text labels to the map, we will want labelling points:  
  
```{r}
label_sf <- 
  reframe(group_by(polygon_sf[polygon_sf$region != "Antarctica",], region), 
          Value = unique(Value), geometry = st_union(geometry))

label_sf$centroid <- st_centroid(label_sf$geometry, of_largest_polygon = TRUE)
label_sf$point_on_surface <- st_point_on_surface(label_sf$geometry)

ggplot(polygon_sf) +
  geom_sf(aes(fill = Value)) +
  geom_sf_text(aes(label = Value, geometry = centroid), data = label_sf,
               size = 2, na.rm = TRUE) +
  theme(legend.position = "bottom")
```
\pagebreak  
  
  

```{r, fig.height = 8, fig.cap = "", out.extra = ""}

pal <- colorspace::diverge_hcl(n = 20)

ggplot(polygon_sf) +
  geom_sf(aes(fill = Value)) +
  geom_sf_text(aes(label = paste(region, Value), geometry = centroid), 
               data = label_sf[!is.na(label_sf$Value), ], size = 2, na.rm = TRUE) +
  xlim(-25, 45) + ylim(-35, 75) +
  theme(legend.position = "bottom") +
  scale_fill_gradientn(colours = pal)
```
